<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aval√∫os Profesionales - Mapa de Ubicaci√≥n con Google Maps</title>
    <meta name="description" content="Sistema profesional de aval√∫os inmobiliarios con integraci√≥n de Google Maps y Supabase">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .security-card {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .security-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .map-controls {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .map-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f1f5f9;
            color: #64748b;
            font-size: 18px;
            font-weight: 500;
        }

        .address-display {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .address-display h3 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .address-display p {
            color: #78350f;
            font-size: 16px;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tip {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Aval√∫os Profesionales</h1>
            <p>Sistema de Valuaci√≥n Inmobiliaria con Google Maps</p>
        </div>
        
        <div class="content">
            <!-- Tarjeta de seguridad -->
            <div class="security-card">
                <svg class="security-icon" viewBox="0 0 24 24">
                    <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C15.4,11.5 16,12.4 16,13V16C16,17.4 15.4,18 14.8,18H9.2C8.6,18 8,17.4 8,16V13C8,12.4 8.4,11.5 9.2,11.5V10C9.2,8.6 10.6,7 12,7M12,8.2C11.2,8.2 10.5,8.7 10.5,10V11.5H13.5V10C13.5,8.7 12.8,8.2 12,8.2Z"/>
                </svg>
                <div>
                    <strong>üîê Conexi√≥n Segura</strong>
                    <p>API key de Google Maps obtenida de forma segura desde Supabase</p>
                </div>
            </div>

            <!-- Error display -->
            <div id="error-container" style="display: none;"></div>

            <!-- Controles del mapa -->
            <div class="map-controls">
                <h3 style="margin-bottom: 20px; color: #1f2937;">üìç Buscar Ubicaci√≥n</h3>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="address-input">Direcci√≥n o lugar:</label>
                        <input 
                            type="text" 
                            id="address-input" 
                            placeholder="Ej: Ciudad de M√©xico, CDMX"
                            value=""
                        >
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button class="btn" id="search-btn" onclick="searchAddress()">
                            üîç Buscar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenedor del mapa -->
            <div class="map-container" id="map-container">
                <div class="map-placeholder">
                    <div class="loading">
                        <p>‚ö° Cargando Google Maps...</p>
                        <p style="font-size: 14px; margin-top: 10px;">Conectando con Supabase para obtener API key segura</p>
                    </div>
                </div>
            </div>

            <!-- Mostrar direcci√≥n actual -->
            <div id="address-display" style="display: none;" class="address-display">
                <h3>üìç Ubicaci√≥n Seleccionada:</h3>
                <p id="current-address"></p>
            </div>

            <!-- Tip para el usuario -->
            <div class="tip">
                üí° <strong>Tip:</strong> Haz clic en cualquier punto del mapa o arrastra el marcador para seleccionar una nueva ubicaci√≥n. La direcci√≥n se actualizar√° autom√°ticamente.
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let map = null;
        let marker = null;
        let geocoder = null;
        let currentAddress = '';

        // Configuraci√≥n de Supabase
        const supabaseUrl = 'https://bgxajhehysoonuzskzoi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJneGFqaGVoeXNvb251enNrem9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTk2MzQsImV4cCI6MjA2OTgzNTYzNH0.y6iMvZr_-MdSmzr0hxcvmn4CpHbvYS0f84geh7XSpws';

        // Funci√≥n para mostrar errores
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">‚ùå Error: ${message}</div>`;
            errorContainer.style.display = 'block';
        }

        // Funci√≥n para ocultar errores
        function hideError() {
            document.getElementById('error-container').style.display = 'none';
        }

        // Funci√≥n para obtener API key de Google Maps desde Supabase
        async function getGoogleMapsApiKey() {
            try {
                const response = await fetch(`${supabaseUrl}/functions/v1/google-maps`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'get-api-key' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data?.apiKey) {
                    throw new Error('No API key received from server');
                }

                return data.apiKey;
            } catch (error) {
                console.error('Error getting API key:', error);
                throw new Error('Failed to get Google Maps API key from server');
            }
        }

        // Funci√≥n para geocodificar direcciones
        async function geocodeAddressWithSupabase(address) {
            try {
                const response = await fetch(`${supabaseUrl}/functions/v1/google-maps`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'geocode',
                        data: { address }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error geocoding address:', error);
                throw error;
            }
        }

        // Funci√≥n para geocodificaci√≥n inversa
        async function reverseGeocodeWithSupabase(lat, lng) {
            try {
                const response = await fetch(`${supabaseUrl}/functions/v1/google-maps`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'reverse-geocode',
                        data: { lat, lng }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                throw error;
            }
        }

        // Funci√≥n para actualizar la ubicaci√≥n
        function updateLocation(lat, lng, address) {
            currentAddress = address;
            document.getElementById('current-address').textContent = address;
            document.getElementById('address-display').style.display = 'block';
            
            console.log('Ubicaci√≥n actualizada:', { lat, lng, address });
        }

        // Funci√≥n para cargar Google Maps
        async function loadGoogleMaps() {
            try {
                hideError();
                
                // Obtener API key de forma segura
                const apiKey = await getGoogleMapsApiKey();
                
                // Cargar la biblioteca de Google Maps
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry`;
                script.async = true;
                script.defer = true;
                
                script.onload = function() {
                    initializeMap();
                };
                
                script.onerror = function() {
                    showError('Error al cargar Google Maps');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                showError(error.message);
            }
        }

        // Funci√≥n para inicializar el mapa
        function initializeMap() {
            const mapContainer = document.getElementById('map-container');
            
            // Coordenadas iniciales (Ciudad de M√©xico)
            const initialPosition = { lat: 19.4326, lng: -99.1332 };
            
            // Crear el mapa
            map = new google.maps.Map(mapContainer, {
                center: initialPosition,
                zoom: 13,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "on" }]
                    }
                ]
            });

            // Crear geocoder
            geocoder = new google.maps.Geocoder();

            // Crear marcador
            marker = new google.maps.Marker({
                position: initialPosition,
                map: map,
                draggable: true,
                title: 'Arrastra para cambiar ubicaci√≥n',
                animation: google.maps.Animation.DROP
            });

            // Evento cuando se arrastra el marcador
            marker.addListener('dragend', function(event) {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                reverseGeocode(lat, lng);
            });

            // Evento cuando se hace clic en el mapa
            map.addListener('click', function(event) {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                
                marker.setPosition(event.latLng);
                reverseGeocode(lat, lng);
            });

            // Geocodificar posici√≥n inicial
            reverseGeocode(initialPosition.lat, initialPosition.lng);

            console.log('Mapa inicializado correctamente');
        }

        // Funci√≥n para geocodificaci√≥n inversa
        async function reverseGeocode(lat, lng) {
            try {
                const data = await reverseGeocodeWithSupabase(lat, lng);
                if (data?.address) {
                    updateLocation(lat, lng, data.address);
                } else {
                    updateLocation(lat, lng, `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
                }
            } catch (error) {
                console.error('Error en geocodificaci√≥n inversa:', error);
                updateLocation(lat, lng, `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
            }
        }

        // Funci√≥n para buscar direcci√≥n
        async function searchAddress() {
            const addressInput = document.getElementById('address-input');
            const searchBtn = document.getElementById('search-btn');
            const address = addressInput.value.trim();
            
            if (!address) {
                showError('Por favor, ingresa una direcci√≥n');
                return;
            }

            if (!map) {
                showError('El mapa no est√° cargado a√∫n');
                return;
            }

            try {
                hideError();
                searchBtn.disabled = true;
                searchBtn.textContent = 'üîç Buscando...';

                const data = await geocodeAddressWithSupabase(address);
                
                if (data?.lat && data?.lng) {
                    const position = { lat: data.lat, lng: data.lng };
                    
                    map.setCenter(position);
                    map.setZoom(15);
                    marker.setPosition(position);
                    
                    updateLocation(data.lat, data.lng, data.address || address);
                } else {
                    showError('No se pudo encontrar la direcci√≥n');
                }
            } catch (error) {
                showError('Error al buscar la direcci√≥n: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'üîç Buscar';
            }
        }

        // Evento para buscar con Enter
        document.getElementById('address-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        });

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadGoogleMaps();
        });
    </script>
</body>
</html>